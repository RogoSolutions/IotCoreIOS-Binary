# TestFlight Release Workflow for IoTCoreSample
#
# This workflow builds a signed IPA and uploads to TestFlight when a new
# GitHub release is published.
#
# Triggers:
#   - GitHub release published
#   - Manual workflow dispatch
#
# Requirements:
#   - Self-hosted macOS runner with:
#     - Xcode 15.0+
#     - Fastlane
#     - XcodeGen
#     - Distribution certificate in Keychain
#     - Provisioning profile installed
#   - Credentials stored on runner:
#     - APPLE_ID, TEAM_ID in ~/.config/fastlane/env
#     - Apple ID password in Keychain (via fastlane-credentials)
#
# NOTE: IOTCORE_APP_KEY and IOTCORE_APP_SECRET are NOT needed.
#       Users configure their own credentials in the app's Settings.
#

name: Release to TestFlight

on:
  release:
    types: [published]

  # Manual trigger option
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
        type: string
      release_notes:
        description: 'Release notes for TestFlight'
        required: false
        type: string
        default: 'New build'

jobs:
  deploy-testflight:
    name: Deploy to TestFlight
    runs-on: [self-hosted, macOS]
    timeout-minutes: 60

    env:
      # Locale settings for fastlane
      LANG: en_US.UTF-8
      LANGUAGE: en_US.UTF-8
      LC_ALL: en_US.UTF-8
      # Build settings
      FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 120
      # Apple credentials
      FASTLANE_USER: ${{ secrets.FASTLANE_USER }}
      FASTLANE_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}
      APPLE_ID: ${{ secrets.FASTLANE_USER }}
      TEAM_ID: H6B975ZR6W

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        id: setup
        run: |
          echo "::group::Environment Info"
          echo "Runner: $(hostname)"
          echo "macOS: $(sw_vers -productVersion)"
          xcodebuild -version
          fastlane --version
          echo "::endgroup::"

      - name: Unlock Keychain
        run: |
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" ~/Library/Keychains/login.keychain-db
          security set-keychain-settings -lut 7200 ~/Library/Keychains/login.keychain-db

      - name: Extract Version
        id: version
        run: |
          # Determine version from input, release tag, or default
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [ -n "${{ github.event.release.tag_name }}" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            # Remove 'v' prefix if present
            VERSION="${VERSION#v}"
          else
            VERSION="1.0.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

          # Set simple release notes (avoid complex markdown from release body)
          echo "RELEASE_NOTES=IotCoreIOS SDK v$VERSION" >> $GITHUB_ENV

      - name: Generate Xcode Project
        working-directory: IoTCoreSample
        run: |
          echo "::group::Generate Xcode Project"
          if command -v xcodegen &> /dev/null; then
            xcodegen generate
            echo "Project generated with XcodeGen"
          elif [ -d "IoTCoreSample.xcodeproj" ]; then
            echo "Using existing Xcode project"
          else
            echo "::error::No Xcode project found"
            exit 1
          fi
          echo "::endgroup::"

      - name: Update Marketing Version
        working-directory: IoTCoreSample
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Marketing Version: $VERSION"

          # Update marketing version in Info.plist (build number is auto-incremented by fastlane)
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" IoTCoreSample/Info.plist

      - name: Resolve Swift Packages
        working-directory: IoTCoreSample
        run: |
          echo "::group::Resolving SPM Dependencies"
          xcodebuild -resolvePackageDependencies \
            -project IoTCoreSample.xcodeproj \
            -scheme IoTCoreSample
          echo "::endgroup::"

      - name: Build and Upload to TestFlight
        working-directory: IoTCoreSample
        run: |
          fastlane release_testflight

      - name: Create Summary
        if: always()
        run: |
          echo "## TestFlight Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Trigger** | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Build uploaded to TestFlight successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The build will be available in App Store Connect shortly." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify Failure
        if: failure()
        run: |
          echo "::error::TestFlight deployment failed. Check the logs for details."
